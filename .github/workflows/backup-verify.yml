name: Daily Backup Verification

on:
  schedule:
    - cron: '0 4 * * *'  # 每天凌晨4点（备份后1小时）
  workflow_dispatch:  # 支持手动触发

jobs:
  backup-verify:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        pip install psycopg2-binary
        
    - name: Verify RDS connection
      env:
        RDS_HOST: ${{ secrets.RDS_HOST }}
        RDS_USER: ${{ secrets.RDS_USER }}
        RDS_PASSWORD: ${{ secrets.RDS_PASSWORD }}
        RDS_DB: ${{ secrets.RDS_DB }}
      run: |
        python -c "
        import psycopg2
        import sys
        try:
            conn = psycopg2.connect(
                host='${{ secrets.RDS_HOST }}',
                user='${{ secrets.RDS_USER }}',
                password='${{ secrets.RDS_PASSWORD }}',
                dbname='${{ secrets.RDS_DB }}'
            )
            cur = conn.cursor()
            cur.execute('SELECT COUNT(*) FROM persons')
            count = cur.fetchone()[0]
            print(f'✅ RDS连接成功，人员表有{count}条记录')
            conn.close()
        except Exception as e:
            print(f'❌ 连接失败: {e}')
            sys.exit(1)
        "
        
    - name: Export database backup
      env:
        RDS_HOST: ${{ secrets.RDS_HOST }}
        RDS_USER: ${{ secrets.RDS_USER }}
        RDS_PASSWORD: ${{ secrets.RDS_PASSWORD }}
        RDS_DB: ${{ secrets.RDS_DB }}
      run: |
        PGPASSWORD=${{ secrets.RDS_PASSWORD }} pg_dump \
          -h ${{ secrets.RDS_HOST }} \
          -U ${{ secrets.RDS_USER }} \
          -d ${{ secrets.RDS_DB }} \
          --no-owner > marvin_db_backup_$(date +%Y%m%d).sql
        
    - name: Upload backup to artifact
      uses: actions/upload-artifact@v4
      with:
        name: database-backup-$(date +%Y%m%d)
        path: marvin_db_backup_*.sql
        retention-days: 7
