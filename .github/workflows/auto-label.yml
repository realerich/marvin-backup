name: Auto Label & Assign

on:
  issues:
    types: [opened, edited]
  pull_request:
    types: [opened, edited]

jobs:
  label-and-assign:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    steps:
      - name: Auto Label Issue
        if: github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title.toLowerCase();
            const body = issue.body?.toLowerCase() || '';
            
            const labels = [];
            
            // æ ¹æ®æ ‡é¢˜è‡ªåŠ¨æ‰“æ ‡ç­¾
            if (title.includes('bug') || title.includes('é”™è¯¯') || title.includes('é—®é¢˜')) {
              labels.push('bug');
            }
            if (title.includes('feature') || title.includes('åŠŸèƒ½') || title.includes('è¯·æ±‚')) {
              labels.push('enhancement');
            }
            if (title.includes('task') || title.includes('ä»»åŠ¡')) {
              labels.push('task');
            }
            if (title.includes('doc') || title.includes('æ–‡æ¡£')) {
              labels.push('documentation');
            }
            
            // æ ¹æ®ä¼˜å…ˆçº§æ‰“æ ‡ç­¾
            if (body.includes('p0') || body.includes('ç´§æ€¥')) {
              labels.push('priority/P0');
            } else if (body.includes('p1') || body.includes('é«˜')) {
              labels.push('priority/P1');
            } else if (body.includes('p2') || body.includes('ä¸­')) {
              labels.push('priority/P2');
            } else if (body.includes('p3') || body.includes('ä½Ž')) {
              labels.push('priority/P3');
            }
            
            if (labels.length > 0) {
              github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: labels
              });
            }
            
            // è‡ªåŠ¨åˆ†é…
            github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              assignees: ['realerich']
            });
            
            // æ·»åŠ æ¬¢è¿Žè¯„è®º
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `ðŸ‘‹ æ„Ÿè°¢æäº¤ï¼å·²è‡ªåŠ¨åˆ†é…å¹¶æ‰“æ ‡ç­¾ã€‚\n\n**å½“å‰æ ‡ç­¾**: ${labels.join(', ') || 'æš‚æ— '}\n**å¤„ç†äºº**: @realerich`
            });

      - name: Auto Label PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });
            
            const labels = [];
            const filePaths = files.data.map(f => f.filename);
            
            // æ ¹æ®ä¿®æ”¹çš„æ–‡ä»¶æ‰“æ ‡ç­¾
            if (filePaths.some(f => f.startsWith('.github/workflows/'))) {
              labels.push('ci/cd');
            }
            if (filePaths.some(f => f.startsWith('docs/'))) {
              labels.push('documentation');
            }
            if (filePaths.some(f => f.endsWith('.py'))) {
              labels.push('python');
            }
            if (filePaths.some(f => f.includes('test'))) {
              labels.push('testing');
            }
            
            if (labels.length > 0) {
              github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: labels
              });
            }
